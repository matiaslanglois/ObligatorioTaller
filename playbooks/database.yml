---
- name: Instalar y asegurar MariaDB
  hosts: database
  become: true
  user: sysadmin
  
  tasks:

  - name: Instalar el paquete de MariaDB
    ansible.builtin.apt:
      name: mariadb-server
      state: present
      update_cache: true

  - name: Asegurarse de que el servicio MariaDB está en ejecución
    ansible.builtin.systemd_service:
      name: mariadb
      state: started
      enabled: true

## MySQL-Secure-Intalation
  - name: Configurar la contraseña de root de MariaDB
    community.mysql.mysql_user:
      name: root
      password: dbroot
      host: localhost
      state: present
    notify:
      - Reiniciar MariaDB

  - name: Eliminar usuarios anónimos
    community.mysql.mysql_user:
      name: ''
      state: absent
      host: localhost
    notify:
      - Reiniciar MariaDB

  - name: Eliminar la base de datos de prueba
    community.mysql.mysql_db:
      name: test
      state: absent
    notify:
      - Reiniciar MariaDB

  - name: Configurar el archivo de configuración de MariaDB
    ansible.builtin.lineinfile:
      path: /etc/mysql/my.cnf
      regexp: '^bind-address'
      line: 'bind-address = 192.168.56.0'
      notify:
        - Reiniciar MariaDB

## Creacion de Base de datos
  - name: Crear una base de datos todo ## Borrar# 
    community.mysql.mysql_db:
      check_implicit_admin: true
      login_host: "{{ hostvars[inventory_hostname].ansible_host }}"
      login_user: root
      login_password: dbadmin
      name: todo
      state: import
      target: ./files/todo.sql
    delegate_to: localhost
    connection: local

  - name: Crear base de datos todo
    community.mysql.mysql_db:
      name: todo
      state: present
      login_user: root
      login_password: tlxroot

  - name: Crear tablas en la base de datos todo
    community.mysql.mysql_query:
      query: |
        CREATE TABLE IF NOT EXISTS `users` (
          `id` int(3) NOT NULL AUTO_INCREMENT,
          `first_name` varchar(20) DEFAULT NULL,
          `last_name` varchar(20) DEFAULT NULL,
          `username` varchar(250) DEFAULT NULL,
          `password` varchar(20) DEFAULT NULL,
          PRIMARY KEY (`id`)
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

        CREATE TABLE IF NOT EXISTS `todos` (
          `id` bigint(20) NOT NULL AUTO_INCREMENT,
          `description` varchar(255) DEFAULT NULL,
          `is_done` bit(1) NOT NULL,
          `target_date` datetime(6) DEFAULT NULL,
          `username` varchar(255) DEFAULT NULL,
          `title` varchar(255) DEFAULT NULL,
          PRIMARY KEY (`id`)
        ) ENGINE=InnoDB AUTO_INCREMENT=8 DEFAULT CHARSET=utf8mb4
        COLLATE=utf8mb4_0900_ai_ci;
      login_db: todo
      login_user: root
      login_password: dbroot

  - name: Crear usuario y conceder permisos en la base de datos todo
    community.mysql.mysql_user:
      name: todo
      password: prueba2024
      priv: "todo.*:ALL"
      state: present
      login_user: root
      login_password: dbroot
      host_all: yes
      update_password: always

  handlers:
  - name: Reiniciar MariaDB
    ansible.builtin.systemd_service:
      name: mariadb
      state: restarted